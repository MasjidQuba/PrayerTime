<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIC Digital Display - Production</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@700&family=Inter:wght@400;700;900&display=swap');
        
        :root {
            --primary-blue: #1e4571;
            --gold: #d4af37;
            --iqama-green: #2e7d32;
            --highlight-row: #fff9c4;
        }

        /* Dynamic Weather Themes */
        body.theme-day { background: linear-gradient(180deg, #87CEEB 0%, #f4f7f9 100%); }
        body.theme-night { background: linear-gradient(180deg, #0a192f 0%, #1e4571 100%); }
        body.theme-night .prayer-row td { background: rgba(255,255,255,0.9); }
        body.theme-cloudy { background: linear-gradient(180deg, #708090 0%, #bdc3c7 100%); }

        body { transition: background 2s ease-in-out; margin: 0; padding: 15px; height: 100vh; display: flex; flex-direction: column; font-family: 'Inter', sans-serif; overflow: hidden; box-sizing: border-box; padding-bottom: 70px; }

        /* Symmetrical Header */
        .header-box { height: 200px; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; background: var(--primary-blue); border-radius: 25px; border: 4px solid var(--gold); color: white; }
        .header-img { height: 130px; width: auto; }
        .clock-section { display: flex; align-items: center; justify-content: center; width: 900px; }

        .sidebar { width: 200px; text-align: center; display: flex; flex-direction: column; justify-content: center; height: 120px; flex-shrink: 0; }
        .left-sidebar { border-right: 3px solid var(--gold); padding-right: 15px; }
        .right-sidebar { border-left: 3px solid var(--gold); padding-left: 15px; }

        .sidebar-main { font-size: 1.5rem; font-weight: 900; color: white; }
        .sidebar-sub { font-size: 1.1rem; color: var(--gold); font-weight: 800; text-transform: uppercase; }

        #clock-container { background-color: #000; color: #fff; width: 310px; height: 160px; border-radius: 20px; border: 3px solid var(--gold); display: flex; align-items: center; justify-content: center; margin: 0 20px; flex-shrink: 0; overflow: hidden; }
        #clock { font-size: 2.8rem; font-weight: 900; font-variant-numeric: tabular-nums; letter-spacing: 1px; white-space: nowrap; }
        /* Tables */
        .prayer-table { width: 100%; margin-top: 10px; border-collapse: separate; border-spacing: 0 10px; table-layout: fixed; }
        .table-header th { color: var(--primary-blue); font-size: 1.8rem; font-weight: 900; text-transform: uppercase; padding: 10px; text-align: center; }
        .prayer-row td { background: white; padding: 18px 10px; text-align: center; font-size: 2.8rem; font-weight: 800; border-bottom: 3px solid var(--gold); }
        .prayer-row.active td { background: var(--highlight-row) !important; border-top: 5px solid var(--gold); border-bottom: 5px solid var(--gold); color: #000; }
        .sunrise-row td { background: #fff3e0; color: #e65100; font-size: 2.2rem; opacity: 0.9; }

        .col-en { text-align: left !important; padding-left: 30px !important; border-radius: 20px 0 0 20px; color: var(--primary-blue); }
        .col-ar { text-align: right !important; padding-right: 30px !important; font-family: 'Amiri', serif; font-size: 3.5rem !important; border-radius: 0 20px 20px 0; color: var(--primary-blue); }

        .hadith-container { flex-grow: 1; min-height: 280px; background: var(--primary-blue); border-radius: 25px; margin-top: 10px; padding: 25px; color: white; display: flex; flex-direction: column; justify-content: center; text-align: center; border: 4px solid var(--gold); overflow-y: auto; }
        .ar-text { font-family: 'Amiri', serif; font-size: 2.1rem; direction: rtl; line-height: 1.3; margin-bottom: 15px; }
        .en-text { font-size: 2.0rem; font-style: italic; color: var(--gold); line-height: 1.3; font-weight: 700; }

        .countdown-bar { background: #2e7d32; color: white; padding: 12px; border-radius: 20px; text-align: center; margin-top: 10px; font-size: 2rem; font-weight: 900; border: 3px solid var(--gold); }
        .footer-contact { background: var(--primary-blue); color: var(--gold); text-align: center; padding: 10px; font-size: 1.5rem; font-weight: 700; border-top: 3px solid var(--gold); width: 100%; position: absolute; bottom: 0; left: 0; }

        /* Two-Row Donation Layout */
        #donation-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: radial-gradient(circle, var(--primary-blue) 0%, #0a192f 100%); display: none; flex-direction: column; justify-content: space-evenly; align-items: center; z-index: 9999; color: white; border: 20px solid var(--gold); box-sizing: border-box; }
        .qr-row { text-align: center; background: white; padding: 20px; border-radius: 25px; border: 6px solid var(--gold); }
        .progress-row { width: 85%; text-align: center; }
        #progress-fill { height: 100%; background: var(--gold); width: 0%; transition: width 2s ease-in-out; }
    </style>
</head>
<body class="theme-day">

<div class="header-box">
    <img src="Muhammad.png" class="header-img" onclick="toggleTestDonation()" style="cursor: pointer;">
    <div class="clock-section">
        <div class="sidebar left-sidebar">
            <div id="greg-day" class="sidebar-main">--</div>
            <div id="greg-date" class="sidebar-sub">-- --- ----</div>
        </div>
        <div id="clock-container"><div id="clock">00:00:00 AM</div></div>
        <div class="sidebar right-sidebar">
            <div id="temp" class="sidebar-main">--¬∞C</div>
            <div id="city-name" class="sidebar-sub">Pickering</div>
            <div id="hijri" style="font-size: 1.2rem; font-weight: 700; color: #fff; margin-top: 5px;">-- --- ----</div>
        </div>
    </div>
    <img src="Allah.png" class="header-img">
</div>

<table class="prayer-table">
    <thead>
        <tr class="table-header">
            <th style="text-align: left; padding-left: 30px;">Salah</th>
            <th>Starting Time</th>
            <th>Iqamah Time</th>
            <th style="text-align: right; padding-right: 30px;">ÿßŸÑÿµŸÑÿßÿ©</th>
        </tr>
    </thead>
    <tbody id="prayer-body"></tbody>
</table>

<div class="hadith-container">
    <div class="ar-text" id="ar-hadith">ÿßŸÑŸíÿ≠ŸéŸÖŸíÿØŸè ŸÑŸêŸÑŸéŸëŸáŸê</div>
    <div class="en-text" id="en-hadith">Loading Hadith...</div>
</div>

<div class="countdown-bar" id="ramadan-countdown">Getting Calendar...</div>

<div id="donation-overlay">
    <div class="qr-row">
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=350x350&data=https://www.ajaxmasjid.ca" alt="QR" style="width: 320px; height: 320px;">
        <div style="color: black; font-weight: 900; margin-top: 10px; font-size: 1.5rem;">SCAN TO DONATE</div>
    </div>

    <div class="progress-row">
        <div style="font-size: 3rem; font-weight: 900; color: var(--gold); margin-bottom: 10px;">PLEASE DONATE GENEROUSLY</div>
        <div style="display: flex; justify-content: space-between; font-size: 2.2rem; font-weight: 800; margin-bottom: 10px;">
            <span id="raised-text">Raised: $0</span>
            <span id="remaining-text" style="color: var(--gold);">Remaining: $0</span>
        </div>
        <div style="width: 100%; height: 50px; background: rgba(255,255,255,0.2); border-radius: 25px; border: 3px solid var(--gold); overflow: hidden;">
            <div id="progress-fill"></div>
        </div>
        <div style="display: flex; justify-content: space-between; margin-top: 10px; font-weight: 700; font-size: 1.6rem;">
            <span id="percent-text">0% Completed</span>
            <span>GOAL: $1.4M</span>
        </div>
    </div>
</div>

<div class="footer-contact">info@ajaxmasjid.ca | www.ajaxmasjid.ca</div>

<script>
    const GOAL = 1400000, RAISED = 100000;
    const iqamaTimes = { Fajr: "6:15 AM", Dhuhr: "1:00 PM", Asr: "4:45 PM", Isha: "8:00 PM" };
    const salahList = [{id:'Fajr',ar:'ÿßŸÑŸÅÿ¨ÿ±'},{id:'Sunrise',ar:'ÿßŸÑÿ¥ÿ±ŸàŸÇ'},{id:'Dhuhr',ar:'ÿßŸÑÿ∏Ÿáÿ±'},{id:'Asr',ar:'ÿßŸÑÿπÿµÿ±'},{id:'Maghrib',ar:'ÿßŸÑŸÖÿ∫ÿ±ÿ®'},{id:'Isha',ar:'ÿßŸÑÿπÿ¥ÿßÿ°'}];
    let forceDonation = false, nextRefresh = 60, userCity = "Pickering", userCountry = "Canada";

    function toggleTestDonation() {
        forceDonation = !forceDonation;
        const ov = document.getElementById('donation-overlay');
        ov.style.display = forceDonation ? 'flex' : 'none';
        if (forceDonation) updateProgressBar();
    }

    function format12Hour(timeStr) {
        if (!timeStr || typeof timeStr !== 'string') return "--:--";
        let clean = timeStr.replace(/AM|PM/gi, '').trim();
        let [h, m] = clean.split(':').map(Number);
        if (isNaN(h)) return timeStr;
        const ampm = timeStr.toLowerCase().includes('pm') || h >= 12 ? 'PM' : 'AM';
        h = h % 12 || 12;
        return `${h}:${m.toString().padStart(2, '0')} ${ampm}`;
    }

    async function updateLocationAndWeather() {
        try {
            const geo = await (await fetch('https://ipapi.co/json/')).json();
            userCity = geo.city; userCountry = geo.country_name;
            const w = await (await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${geo.latitude}&longitude=${geo.longitude}&current_weather=true`)).json();
            
            // Fixed negative temperature handling
            const currentTemp = Math.round(w.current_weather.temperature);
            document.getElementById('temp').innerText = currentTemp + "¬∞C";
            document.getElementById('city-name').innerText = userCity;

            const b = document.body; b.classList.remove('theme-day','theme-night','theme-cloudy');
            if (w.current_weather.weathercode >= 3) b.classList.add('theme-cloudy');
            else if (w.current_weather.is_day) b.classList.add('theme-day');
            else b.classList.add('theme-night');
        } catch (e) { 
            document.getElementById('city-name').innerText = "Pickering"; 
            document.getElementById('temp').innerText = "-12¬∞C"; // Fixed fallback
        }
        updateData();
    }

    async function updateData() {
    try {
        // FIXED: Using backticks for template literals and school=1 for Hanafi
        const url = `https://api.aladhan.com/v1/timingsByCity?city=${userCity}&country=${userCountry}&method=1&school=1`;
        const response = await fetch(url);
        const d = await response.json();
        
        const t = d.data.timings;
        document.getElementById('hijri').innerText = `${d.data.date.hijri.day} ${d.data.date.hijri.month.en} ${d.data.date.hijri.year}`;
        
        const now = new Date();
        const curMinutes = now.getHours() * 60 + now.getMinutes();
        
        let idx = 0;
        let html = '';
        
        salahList.forEach((s, i) => {
            const [p_h, p_m] = t[s.id].split(':').map(Number);
            const pMinutes = p_h * 60 + p_m;
            
            // Determine if this is the current active prayer
            if (curMinutes >= pMinutes) idx = i;
        });

        salahList.forEach((s, i) => {
            const active = (i === idx) ? "active" : "";
            let adhan = format12Hour(t[s.id]), iqama;
            
            if (s.id === 'Sunrise') iqama = 'Ishraq';
            else if (s.id === 'Maghrib') {
                const [h, m] = t[s.id].split(':').map(Number);
                const dt = new Date(); dt.setHours(h); dt.setMinutes(m + 3);
                iqama = format12Hour(dt.getHours() + ":" + dt.getMinutes());
            } else iqama = format12Hour(iqamaTimes[s.id]);
            
            html += `<tr class="prayer-row ${s.id==='Sunrise'?'sunrise-row':''} ${active}">
                <td class="col-en">${s.id}</td><td>${adhan}</td>
                <td style="color:var(--iqama-green)">${iqama}</td><td class="col-ar">${s.ar}</td></tr>`;
        });
        document.getElementById('prayer-body').innerHTML = html;
    } catch (e) { console.log("Data Error:", e); }
}

    function updateProgressBar() {
        const p = Math.min((RAISED/GOAL)*100, 100);
        document.getElementById('raised-text').innerText = `Raised: $${RAISED.toLocaleString()}`;
        document.getElementById('remaining-text').innerText = `Remaining: $${(GOAL-RAISED).toLocaleString()}`;
        document.getElementById('percent-text').innerText = `${p.toFixed(1)}% Completed`;
        setTimeout(()=> document.getElementById('progress-fill').style.width = p+"%", 100);
    }

    async function updateHadith() {
        try {
            const [en, ar] = await Promise.all([
                fetch(`https://cdn.jsdelivr.net/gh/fawazahmed0/hadith-api@1/editions/eng-bukhari.json`).then(r => r.json()),
                fetch(`https://cdn.jsdelivr.net/gh/fawazahmed0/hadith-api@1/editions/ara-bukhari.json`).then(r => r.json())
            ]);
            const shorts = en.hadiths.filter(h => h.text.length < 200 && h.text.length > 30);
            const rand = Math.floor(Math.random() * shorts.length);
            const origIdx = en.hadiths.indexOf(shorts[rand]);
            document.getElementById('ar-hadith').innerText = ar.hadiths[origIdx].text;
            document.getElementById('en-hadith').innerText = `"${en.hadiths[origIdx].text}" ‚Äî Bukhari`;
        } catch (e) { console.log("Hadith Error"); }
        nextRefresh = 900;
    }

    function runClock() {
        const now = new Date();
        document.getElementById('clock').innerText = now.toLocaleTimeString('en-US', { hour:'numeric', minute:'2-digit', second:'2-digit', hour12:true });
        const d = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
        const m = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
        document.getElementById('greg-day').innerText = d[now.getDay()];
        document.getElementById('greg-date').innerText = `${now.getDate()} ${m[now.getMonth()]} ${now.getFullYear()}`;
        
        const curM = now.getHours()*60 + now.getMinutes();
        let showD = false;
        // Auto trigger: 10 mins window
        [400, 805, 1000, 1210].forEach(t => { if(curM >= t+6 && curM < t+16) showD = true; });
        const ov = document.getElementById('donation-overlay');
        if (forceDonation || showD) {
            ov.style.display = 'flex';
            updateProgressBar();
        } else {
            ov.style.display = 'none';
        }
        
        nextRefresh--; if(nextRefresh<=0) updateHadith();
        const rd = new Date(2026, 1, 19);
        const diff = Math.ceil((rd - now)/(1000*60*60*24));
        document.getElementById('ramadan-countdown').innerText = diff > 0 ? `üåô ${diff} DAYS UNTIL RAMADAN` : `üåô RAMADAN MUBARAK`;
    }

    setInterval(runClock, 1000); setInterval(updateData, 60000); setInterval(updateLocationAndWeather, 600000);
    updateLocationAndWeather(); updateHadith(); runClock();
</script>
</body>
</html>
















