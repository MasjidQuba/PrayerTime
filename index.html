<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIC Digital Display - GitHub Live</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@700&family=Inter:wght@400;700;900&display=swap');
        :root {
            --bg-color: #f4f7f9;
            --primary-blue: #1e4571;
            --gold: #d4af37;
            --iqama-green: #2e7d32;
            --text-light: #ffffff;
            --highlight-row: #fff9c4;
        }
        body { background-color: var(--bg-color); margin: 0; padding: 15px; height: 100vh; display: flex; flex-direction: column; font-family: 'Inter', sans-serif; overflow: hidden; box-sizing: border-box; }

        .header-box { background: var(--primary-blue); border-radius: 25px; display: flex; justify-content: space-between; align-items: center; padding: 10px 40px; color: white; height: 180px; border: 4px solid var(--gold); }
        .header-img { height: 140px; width: auto; }
        #clock { font-size: 6rem; font-weight: 900; line-height: 1; letter-spacing: -2px; }

        .prayer-table { width: 100%; margin-top: 10px; border-collapse: separate; border-spacing: 0 10px; table-layout: fixed; }
        .prayer-row td { background: white; padding: 22px 10px; text-align: center; font-size: 3rem; font-weight: 800; border-bottom: 3px solid var(--gold); }
        .prayer-row.active td { background: var(--highlight-row) !important; border-top: 6px solid var(--gold); border-bottom: 6px solid var(--gold); transform: scale(1.02); color: #000; }
        .sunrise-row td { background: #fff3e0; color: #e65100; font-size: 2.5rem; border-bottom: 2px dashed #e65100; opacity: 0.9; }

        .col-en { text-align: left !important; padding-left: 35px !important; border-radius: 20px 0 0 20px; color: var(--primary-blue); }
        .col-ar { text-align: right !important; padding-right: 35px !important; font-family: 'Amiri', serif; font-size: 3.8rem !important; border-radius: 0 20px 20px 0; color: var(--primary-blue); }

        .hadith-container {
            flex-grow: 1;
            min-height: 300px;
            background: var(--primary-blue);
            border-radius: 25px;
            margin-top: 15px;
            padding: 30px;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: center;
            border: 4px solid var(--gold);
            overflow-y: auto;
        }
        .ar-text { font-family: 'Amiri', serif; font-size: 3.0rem; direction: rtl; line-height: 1.4; margin-bottom: 20px; word-wrap: break-word; transition: opacity 0.5s ease-in-out; }
        .en-text { font-size: 3.0rem; font-style: italic; color: var(--gold); line-height: 1.4; word-wrap: break-word; margin-top: 10px; font-weight: 700; transition: opacity 0.5s ease-in-out; }

        .countdown-bar { background: #2e7d32; color: white; padding: 15px; border-radius: 20px; text-align: center; margin-top: 15px; margin-bottom: 20px; font-size: 2.2rem; font-weight: 900; border: 4px solid var(--gold); }
    </style>
</head>
<body>

<div class="header-box">
    <img src="Muhammad.png" class="header-img">
    <div style="text-align: center; flex-grow: 1;">
        <div id="clock">00:00:00</div>
        <div style="color: var(--gold); font-weight: 800; font-size: 1.8rem;">
            <span id="temp">--¬∞C</span> | Pickering
        </div>
        <div id="hijri" style="font-size: 1.6rem; font-weight: 700;">-- --- ----</div>
    </div>
    <img src="Allah.png" class="header-img">
</div>

<table class="prayer-table">
    <tbody id="prayer-body"></tbody>
</table>

<div class="hadith-container">
    <div class="ar-text" id="ar-hadith">ÿßŸÑŸíÿ≠ŸéŸÖŸíÿØŸè ŸÑŸêŸÑŸéŸëŸáŸê</div>
    <div class="en-text" id="en-hadith">Loading wisdom...</div>
    <div id="debug-timer" style="font-size: 1rem; color: var(--gold); margin-top: 15px; opacity: 0.6;">Next rotation in: 60s</div>
</div>

<div class="countdown-bar" id="ramadan-countdown">Calculating...</div>

<script>
    const iqamaTimes = { Fajr: "6:30", Dhuhr: "1:00", Asr: "4:15", Maghrib: "3 mins after", Isha: "8:00" };
    const salahList = [{id:'Fajr',ar:'ÿßŸÑŸÅÿ¨ÿ±',t:'p'},{id:'Sunrise',ar:'ÿßŸÑÿ¥ÿ±ŸàŸÇ',t:'s'},{id:'Dhuhr',ar:'ÿßŸÑÿ∏Ÿáÿ±',t:'p'},{id:'Asr',ar:'ÿßŸÑÿπÿµÿ±',t:'p'},{id:'Maghrib',ar:'ÿßŸÑŸÖÿ∫ÿ±ÿ®',t:'p'},{id:'Isha',ar:'ÿßŸÑÿπÿ¥ÿßÿ°',t:'p'}];
    
    let nextRefresh = 60; // Testing speed

    function updateRamadan() {
        const diff = new Date("2026-02-19T00:00:00") - new Date();
        const days = Math.ceil(diff / 86400000);
        const el = document.getElementById('ramadan-countdown');
        if (days > 1) el.innerText = `üåô ${days} DAYS UNTIL RAMADAN 1447H`;
        else if (days === 1) el.innerText = `üåô RAMADAN BEGINS TOMORROW`;
        else el.innerText = `üåô RAMADAN MUBARAK - DAY ${Math.abs(days) + 1}`;
    }

    async function updateWeather() {
        try {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=43.8384&longitude=-79.0868&current_weather=true`);
            const d = await res.json();
            document.getElementById('temp').innerText = Math.round(d.current_weather.temperature) + "¬∞C";
        } catch (e) { console.log("Weather Error"); }
    }

    async function updateData() {
        try {
            const res = await fetch(`https://api.aladhan.com/v1/timingsByCity?city=Pickering&country=Canada&method=2&school=1`);
            const d = await res.json();
            const t = d.data.timings;
            document.getElementById('hijri').innerText = `${d.data.date.hijri.day} ${d.data.date.hijri.month.en} ${d.data.date.hijri.year}`;

            const now = new Date();
            const cur = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');

            let idx = 0;
            for(let i=0; i<salahList.length; i++) {
                if(salahList[i].t === 'p' && cur >= t[salahList[i].id]) idx = i;
            }

            let html = '';
            salahList.forEach((s, i) => {
                const isSun = s.t === 's';
                const active = (i === idx) ? "active" : "";
                html += `<tr class="prayer-row ${isSun?'sunrise-row':''} ${active}">
                    <td class="col-en">${isSun?'Sunrise':s.id}</td>
                    <td>${t[s.id]}</td>
                    <td style="color:var(--iqama-green)">${isSun?'Ishraq':iqamaTimes[s.id]}</td>
                    <td class="col-ar">${s.ar}</td></tr>`;
            });
            document.getElementById('prayer-body').innerHTML = html;
        } catch (e) { console.log("Prayer Data Error"); }
    }

    let nextRefresh = 60; 

async function updateHadith() {
    console.log("Triggering Rotation...");
    
    // MOVE THIS TO THE TOP: Reset timer immediately so the logic doesn't hang
    nextRefresh = 60; 

    const arEl = document.getElementById('ar-hadith');
    const enEl = document.getElementById('en-hadith');

    try {
        // Add a 5-second timeout to the fetch itself
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);

        const cacheBuster = new Date().getTime();
        const res = await fetch(`https://random-hadith-generator.vercel.app/api/hadith/bukhari?t=${cacheBuster}`, { signal: controller.signal });
        
        if (!res.ok) throw new Error('API Timeout/Error');
        
        const d = await res.json();
        clearTimeout(timeoutId);

        if (d?.data?.ar && d?.data?.en) {
            arEl.style.opacity = 0;
            enEl.style.opacity = 0;
            
            setTimeout(() => {
                arEl.innerText = d.data.ar;
                enEl.innerText = `"${d.data.en}" ‚Äî ${d.data.book || "Sahih Bukhari"}`;
                arEl.style.opacity = 1;
                enEl.style.opacity = 1;
            }, 500);
            return; // Success!
        }
    } catch (e) {
        console.log("API failed, rotating to local fallback...");
    }

    // FALLBACK: If API fails or times out, pick a random local one
    // This ensures the Hadith ALWAYS changes even without internet
    const fallbacks = [
        { ar: "ÿßŸÑÿØŸéŸëÿßŸÑŸèŸë ÿπŸéŸÑŸéŸâ ÿßŸÑŸíÿÆŸéŸäŸíÿ±Ÿê ŸÉŸéŸÅŸéÿßÿπŸêŸÑŸêŸáŸê", en: "The one who guides to something good has a reward similar to the one who does it." },
        { ar: "ÿ™Ÿéÿ®Ÿéÿ≥ŸèŸëŸÖŸèŸÉŸé ŸÅŸêŸä ŸàŸéÿ¨ŸíŸáŸê ÿ£ŸéÿÆŸêŸäŸÉŸé ŸÑŸéŸÉŸé ÿµŸéÿØŸéŸÇŸéÿ©Ÿå", en: "Your smiling in the face of your brother is charity." },
        { ar: "ÿÆŸéŸäŸíÿ±ŸèŸÉŸèŸÖŸí ŸÖŸéŸÜŸí ÿ™ŸéÿπŸéŸÑŸéŸëŸÖŸé ÿßŸÑŸíŸÇŸèÿ±Ÿíÿ¢ŸÜŸé ŸàŸéÿπŸéŸÑŸéŸëŸÖŸéŸáŸè", en: "The best among you are those who learn the Quran and teach it." }
    ];
    
    const pick = fallbacks[Math.floor(Math.random() * fallbacks.length)];
    arEl.style.opacity = 0;
    enEl.style.opacity = 0;
    
    setTimeout(() => {
        arEl.innerText = pick.ar;
        enEl.innerText = `"${pick.en}" ‚Äî Local Fallback`;
        arEl.style.opacity = 1;
        enEl.style.opacity = 1;
    }, 500);
}
    // --- ENGINE START ---
    setInterval(runClock, 1000);
    setInterval(updateData, 60000);
    setInterval(updateWeather, 600000);

    // Initial Load (Run each once on startup)
    runClock(); 
    updateData(); 
    updateWeather(); 
    updateHadith();
</script>
</body>
</html>

